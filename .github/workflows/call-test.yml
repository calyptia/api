name: Component test for API
on:
  workflow_call:
    inputs:
      api-ref:
        description: The Github commit, SHA, branch or tag to use for the calyptia/api repository.
        type: string
        required: false
        default: 'main'
      cloud-ref:
        # TODO: move to common test set up repo or remove with all-in-one image
        description: The Github commit, SHA, branch or tag to use for the calyptia/cloud repository.
        type: string
        required: false
        default: 'main'
      cloud-image-ref:
        description: The image tag for the ghcr.io/calyptia/cloud image.
        type: string
        required: false
        default: 'main' #${{ inputs.cloud-ref }}
    secrets:
      token:
        description: The Github token to use, must be passed in.
        required: true
      token-username:
        description: The username associated with the Github token.
        required: true

jobs:
  schema-lint:
    name: Schema linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          repository: calyptia/api
          token: ${{ secrets.token }}
          ref: ${{ inputs.api-ref || 'main' }}

      - run: docker run --rm -v $PWD:/spec redocly/openapi-cli lint spec/open-api.yml
        shell: bash

  schema-validation:
    name: Schema validation
    runs-on: ubuntu-latest
    steps:
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{ secrets.token-username }}
          password: ${{ secrets.token }}

      - uses: actions/checkout@v2
        with:
          repository: calyptia/api
          token: ${{ secrets.token }}
          ref: ${{ inputs.api-ref || 'main' }}
          path: api

      - uses: actions/checkout@v2
        with:
          repository: calyptia/cloud
          token: ${{ secrets.token }}
          ref: ${{ inputs.cloud-ref || 'main' }}
          path: cloud

      - name: Run up cloud support infrastructure
        # TODO: replace with all-in-one: https://github.com/calyptia/cloud/issues/308
        run: |
          docker-compose up -d
          docker run -d --network=host \
            --name cloud \
            -e DEBUG=true \
            -e DEFAULT_TOKEN_FILE=/api/token -v $PWD/../api:/api:Z \
            ghcr.io/calyptia/cloud:$IMAGE_TAG
        shell: bash
        working-directory: cloud
        env:
          IMAGE_TAG: ${{ inputs.cloud-image-ref || 'main' }}

      - name: Check we have a token file
        timeout-minutes: 1
        run: |
          until [ -f ./token ]
          do
            sleep 1
          done
          echo "Found token file"
          sudo chmod a+r ./token
          ls -l ./token
        working-directory: api
        shell: bash

      - name: Run up the schema validation container
        timeout-minutes: 5
        run: |
          export TOKENFILE=$PWD/token
          /bin/bash ./scripts/schema_validation.sh
        shell: bash
        working-directory: api

      - name: Dump docker logs on failure
        if: failure()
        continue-on-error: true
        uses: jwalton/gh-docker-logs@v1
